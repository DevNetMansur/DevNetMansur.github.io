<!DOCTYPE html>
<html lang="zh-CN">
  <head><meta name="generator" content="Hexo 3.8.0">
    
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

<meta name="theme-color" content="#f8f5ec">
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="referrer" content="no-referrer">



  <meta name="description" content="优化MacOS的Anyconnect安装包">




  <meta name="keywords" content="network, SSLVPN, cisco, I'm Mansur">










  <link rel="alternate" href="/atom.xml" title="I'm Mansur">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.10.2">



<link rel="canonical" href="http://nbma.info/redeploy-anyconnect-for-macos/">



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css">




  <link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css">



<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.10.2">



  


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-126503503-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-126503503-1');
</script>


  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>









<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":true};
</script>

    <title> 优化MacOS的Anyconnect安装包 - I'm Mansur </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">I'm Mansur</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            标签
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            关于
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">I'm Mansur</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              标签
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          优化MacOS的Anyconnect安装包
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-08-06
        </span>
        
          <span class="post-category">
            
              <a href="/categories/技术笔记/">技术笔记</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        <p>Mac系统的Anyconnect Predeploy安装包中集成了VPN、Web Security、Diagnostics and Reporting Tool、AMP Enabler、Posture、ISE Posture、Network Visibility、Umbrella Roaming Security组件，在正常的安装过程中，这些组件都是默认勾选安装的。</p>
<a id="more"></a>
<p>虽然安装过程很简单，但是难免有傻X用户看都不看直接下一步，所以我决定优化一下客户端。</p>
<hr>
<p>最开始的思路是先从官方找，除了Predeploy版本外，官方还提供了Web deploy版本，这两个版本的区别在于Web deploy用于上传到ASA内部，用户从web端访问VPN的时候自动部署anyconnect软件；Pre Deploy是用于预先部署的单独安装包。</p>
<p>官方的<a href="https://www.cisco.com/c/en/us/td/docs/security/vpn_client/anyconnect/anyconnect47/administration/guide/b_AnyConnect_Administrator_Guide_4-7/deploy-anyconnect.html" target="_blank" rel="noopener">anyconnect手册</a>中写了如何通过ASDM定制安装包，但是经过测试ASDM仅支持windows版的定制，手册也没有提供macOS版的相关参数。<br>不过在手册的<code>#Disable the Customer Experience Feedback Module</code>章节发现了一段描述可以把dmg文件从只读转换为可读写。</p>
<blockquote>
<p>Convert the dmg package from read-only to read-write using Disk Utility or hdiutil. For example:</p>
<p>hdiutil convert anyconnect-macosx-i386-ver-k9.dmg -format UDRW -o anyconnect-macosx-i386-ver-k9-rw.dmg</p>
</blockquote>
<p>那么新的思路就是修改dmg文件包的内容，再重新打包。<br>首先是打开<code>anyconnect-macos-4.7.01076-predeploy-k9.dmg</code>，把<code>Anyconnect.pkg</code>复制出来。<br>使用<code>pkgutil</code>工具解压，目录结构如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ pkgutil --expand AnyConnect.pkg anyconnect</span><br><span class="line"></span><br><span class="line">$ tree -L 1 anyconnect</span><br><span class="line">anyconnect</span><br><span class="line">├── Distribution</span><br><span class="line">├── Resources</span><br><span class="line">├── dart_module.pkg</span><br><span class="line">├── fireamp_module.pkg</span><br><span class="line">├── iseposture_module.pkg</span><br><span class="line">├── nvm_module.pkg</span><br><span class="line">├── posture_module.pkg</span><br><span class="line">├── umbrella_module.pkg</span><br><span class="line">├── vpn_module.pkg</span><br><span class="line">└── websecurity_module.pkg</span><br></pre></td></tr></table></figure>
<p><code>Distribution</code>是安装过程中的配置文件<br><code>Resources</code>是安装过程中的字体、license服务协议、背景图片等资源<br>其他的pkg就是各个组件了。</p>
<p>优化的办法就删掉其他pkg，只保留<code>vpn_module.pkg</code>。然后在修改<code>Distribution</code>，注释或者删掉其他组件的调用：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8" standalone="yes"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">installer-gui-script</span> <span class="attr">minSpecVersion</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>AnyConnect Secure Mobility Client<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">background</span> <span class="attr">file</span>=<span class="string">"pkg_background.png"</span> <span class="attr">scaling</span>=<span class="string">"proportional"</span> <span class="attr">alignment</span>=<span class="string">"bottomleft"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">license</span> <span class="attr">file</span>=<span class="string">"License.rtf"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">options</span> <span class="attr">customize</span>=<span class="string">"always"</span> <span class="attr">rootVolumeOnly</span>=<span class="string">"true"</span> <span class="attr">hostArchitectures</span>=<span class="string">"i386"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">choices-outline</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">line</span> <span class="attr">choice</span>=<span class="string">"choice_vpn"</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--         &lt;line choice="choice_websecurity"/&gt;</span></span><br><span class="line"><span class="comment">        &lt;line choice="choice_fireamp"/&gt;</span></span><br><span class="line"><span class="comment">        &lt;line choice="choice_dart"/&gt;</span></span><br><span class="line"><span class="comment">        &lt;line choice="choice_posture"/&gt;</span></span><br><span class="line"><span class="comment">        &lt;line choice="choice_iseposture"/&gt;</span></span><br><span class="line"><span class="comment">        &lt;line choice="choice_nvm"/&gt;</span></span><br><span class="line"><span class="comment">        &lt;line choice="choice_umbrella"/&gt; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">choices-outline</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">choice</span> <span class="attr">id</span>=<span class="string">"choice_vpn"</span> <span class="attr">start_enabled</span>=<span class="string">"enable_module()"</span> <span class="attr">enabled</span>=<span class="string">"choice_vpn_enabled()"</span> <span class="attr">start_selected</span>=<span class="string">"check_upgrade()"</span> <span class="attr">selected</span>=<span class="string">"choice_vpn_selected()"</span> <span class="attr">title</span>=<span class="string">"VPN"</span> <span class="attr">description</span>=<span class="string">"Installs the module that enables VPN capabilities."</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pkg-ref</span> <span class="attr">id</span>=<span class="string">"com.cisco.pkg.anyconnect.vpn"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">choice</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--     &lt;choice id="choice_websecurity" start_selected="check_upgrade()" start_enabled="enable_module()" title="Web Security" description="Installs the WebSecurity module that enables cloud scanning of web content to protect against malware and enforce acceptable use policies via the ScanSafe cloud proxies."&gt;</span></span><br><span class="line"><span class="comment">        &lt;pkg-ref id="com.cisco.pkg.anyconnect.websecurity_v2"/&gt;</span></span><br><span class="line"><span class="comment">    &lt;/choice&gt;</span></span><br><span class="line"><span class="comment">    &lt;choice id="choice_dart" start_selected="check_upgrade()" start_enabled="enable_module()" title="Diagnostics and Reporting Tool" description="Installs the diagnostics module that collects AnyConnect Secure Mobility Client troubleshooting information."&gt;</span></span><br><span class="line"><span class="comment">        &lt;pkg-ref id="com.cisco.pkg.anyconnect.dart"/&gt;</span></span><br><span class="line"><span class="comment">    &lt;/choice&gt;</span></span><br><span class="line"><span class="comment">    &lt;choice id="choice_fireamp" start_selected="check_upgrade()" start_enabled="enable_module()" title="AMP Enabler" description="Installs the AMP Enabler module that downloads and deploys AMP for Endpoints, as configured by the administrator."&gt;</span></span><br><span class="line"><span class="comment">        &lt;pkg-ref id="com.cisco.pkg.anyconnect.fireamp"/&gt;</span></span><br><span class="line"><span class="comment">    &lt;/choice&gt;</span></span><br><span class="line"><span class="comment">    &lt;choice id="choice_posture" start_selected="check_upgrade()" start_enabled="enable_module()" title="Posture" description="Installs the module that provides the AnyConnect Secure Mobility Client with the ability to identify the operating system, antivirus, antispyware, and firewall software installed on the host prior to creating a remote access connection to the secure gateway."&gt;</span></span><br><span class="line"><span class="comment">        &lt;pkg-ref id="com.cisco.pkg.anyconnect.posture"/&gt;</span></span><br><span class="line"><span class="comment">    &lt;/choice&gt;</span></span><br><span class="line"><span class="comment">    &lt;choice id="choice_iseposture" start_selected="check_upgrade()" start_enabled="enable_module()" title="ISE Posture" description="Installs the module that provides the AnyConnect Secure Mobility Client with the functionality needed to authenticate to wired or wireless networks controlled by the Identity Services Engine, including examination and any needed remediation of the connecting host environment."&gt;</span></span><br><span class="line"><span class="comment">        &lt;pkg-ref id="com.cisco.pkg.anyconnect.iseposture"/&gt;</span></span><br><span class="line"><span class="comment">    &lt;/choice&gt;</span></span><br><span class="line"><span class="comment">    &lt;choice id="choice_nvm" start_selected="check_upgrade()" start_enabled="enable_module()" title="Network Visibility" description="Installs the Network Visibility Module which collects application telemetry data."&gt;</span></span><br><span class="line"><span class="comment">        &lt;pkg-ref id="com.cisco.pkg.anyconnect.nvm_v2"/&gt;</span></span><br><span class="line"><span class="comment">    &lt;/choice&gt;</span></span><br><span class="line"><span class="comment">    &lt;choice id="choice_umbrella" start_selected="check_upgrade()" start_enabled="enable_module()" title="Umbrella Roaming Security" description="Installs the module that enables Umbrella Roaming Security."&gt;</span></span><br><span class="line"><span class="comment">        &lt;pkg-ref id="com.cisco.pkg.anyconnect.umbrella"/&gt;</span></span><br><span class="line"><span class="comment">    &lt;/choice&gt; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pkg-ref</span> <span class="attr">id</span>=<span class="string">"com.cisco.pkg.anyconnect.vpn"</span> <span class="attr">version</span>=<span class="string">"4.7.01076"</span> <span class="attr">installKBytes</span>=<span class="string">"22150"</span>&gt;</span>#vpn_module.pkg<span class="tag">&lt;/<span class="name">pkg-ref</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--     &lt;pkg-ref id="com.cisco.pkg.anyconnect.dart" version="4.7.01076" installKBytes="4608"&gt;#dart_module.pkg&lt;/pkg-ref&gt;</span></span><br><span class="line"><span class="comment">    &lt;pkg-ref id="com.cisco.pkg.anyconnect.websecurity_v2" version="4.7.01076" installKBytes="3052"&gt;#websecurity_module.pkg&lt;/pkg-ref&gt;</span></span><br><span class="line"><span class="comment">    &lt;pkg-ref id="com.cisco.pkg.anyconnect.fireamp" version="4.7.01076" installKBytes="786"&gt;#fireamp_module.pkg&lt;/pkg-ref&gt;</span></span><br><span class="line"><span class="comment">    &lt;pkg-ref id="com.cisco.pkg.anyconnect.posture" version="4.7.01076" installKBytes="51264"&gt;#posture_module.pkg&lt;/pkg-ref&gt;</span></span><br><span class="line"><span class="comment">    &lt;pkg-ref id="com.cisco.pkg.anyconnect.iseposture" version="4.7.01076" installKBytes="3010"&gt;#iseposture_module.pkg&lt;/pkg-ref&gt;</span></span><br><span class="line"><span class="comment">    &lt;pkg-ref id="com.cisco.pkg.anyconnect.nvm_v2" version="4.7.01076" installKBytes="1485"&gt;#nvm_module.pkg&lt;/pkg-ref&gt;</span></span><br><span class="line"><span class="comment">    &lt;pkg-ref id="com.cisco.pkg.anyconnect.umbrella" version="4.7.01076" installKBytes="3645"&gt;#umbrella_module.pkg&lt;/pkg-ref&gt; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">installation-check</span> <span class="attr">script</span>=<span class="string">"InstallationCheck()"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">volume-check</span> <span class="attr">script</span>=<span class="string">"VolumeCheck()"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> gUpgradeModules = [];</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">check_upgrade</span>(<span class="params"></span>)</span></span></span><br><span class="line"><span class="undefined">    &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> modulePkgInfo = my.choice.packages[<span class="number">0</span>];</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> moduleReceipt = my.target.receiptForIdentifier(modulePkgInfo.identifier);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (moduleReceipt)</span></span><br><span class="line"><span class="undefined">        &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> comparison = system.compareVersions(moduleReceipt.version, modulePkgInfo.version);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">            <span class="keyword">if</span> (comparison == <span class="number">0</span>)</span></span><br><span class="line"><span class="undefined">            &#123;</span></span><br><span class="line"><span class="javascript">                system.log(<span class="string">"Found an existing installed version: "</span> + my.choice.title);</span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">        gUpgradeModules.push(my.choice.id);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> <span class="literal">true</span>;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">enable_module</span>(<span class="params"></span>)</span></span></span><br><span class="line"><span class="undefined">    &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> moduleID = my.choice.id;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> (gUpgradeModules.indexOf(moduleID) &amp;gt; <span class="number">-1</span>);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">InstallationCheck</span>(<span class="params"></span>)</span></span></span><br><span class="line"><span class="undefined">    &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span>(!(system.compareVersions(system.version.ProductVersion, <span class="string">'10.9'</span>) &amp;gt;= <span class="number">0</span>))</span></span><br><span class="line"><span class="undefined">        &#123;</span></span><br><span class="line"><span class="javascript">            my.result.title = <span class="string">'Cisco AnyConnect Secure Mobility Client'</span>;</span></span><br><span class="line"><span class="javascript">            my.result.message = <span class="string">'This software requires Mac OS X version 10.9 or later.'</span>;</span></span><br><span class="line"><span class="javascript">            my.result.type = <span class="string">'Fatal'</span>;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> <span class="literal">true</span>;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">VolumeCheck</span>(<span class="params"></span>)</span></span></span><br><span class="line"><span class="undefined">    &#123;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// version of VPN being installed has to be higher than the version already installed</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> vpnReceipt = my.target.receiptForIdentifier(<span class="string">"com.cisco.pkg.anyconnect.vpn"</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> vpnPackage = choices.choice_vpn.packages[<span class="number">0</span>];</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">        <span class="comment">// if the receipt is not there assume no VPN installed or pre-3.1.1 version so it is OK to install</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (vpnReceipt)</span></span><br><span class="line"><span class="undefined">        &#123;</span></span><br><span class="line"><span class="javascript">            <span class="comment">// there is a 3.1.1+ version of VPN already installed</span></span></span><br><span class="line"><span class="javascript">            <span class="comment">// check to see if version in this package is newer</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> comparison = system.compareVersions(vpnReceipt.version, vpnPackage.version);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">            <span class="keyword">if</span> (comparison &amp;gt; <span class="number">0</span>)</span></span><br><span class="line"><span class="undefined">            &#123;</span></span><br><span class="line"><span class="javascript">                <span class="comment">// installed version is newer</span></span></span><br><span class="line"><span class="javascript">                my.result.message = <span class="string">'Newer version '</span> + vpnReceipt.version + <span class="string">' of the Cisco AnyConnect Secure Mobility Client is already installed.'</span>;</span></span><br><span class="line"><span class="javascript">                my.result.type = <span class="string">'Fatal'</span>;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">           &#125;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> <span class="literal">true</span>;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">choice_vpn_enabled</span>(<span class="params"></span>)</span></span></span><br><span class="line"><span class="undefined">    &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (!enable_module())</span></span><br><span class="line"><span class="undefined">        &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> (!choices.choice_websecurity.selected &amp;amp;&amp;amp; !choices.choice_posture.selected &amp;amp;&amp;amp; !choices.choice_iseposture.selected &amp;amp;&amp;amp; !choices.choice_fireamp.selected &amp;amp;&amp;amp; !choices.choice_nvm.selected &amp;amp;&amp;amp; !choices.choice_umbrella.selected);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">choice_vpn_selected</span>(<span class="params"></span>)</span></span></span><br><span class="line"><span class="undefined">    &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (!enable_module())</span></span><br><span class="line"><span class="undefined">        &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">    	</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> tSelected;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">        tSelected=((choices.choice_websecurity.selected || choices.choice_posture.selected || choices.choice_iseposture.selected || choices.choice_fireamp.selected || choices.choice_nvm.selected || choices.choice_umbrella.selected) || (!choices.choice_websecurity.selected &amp;amp;&amp;amp; !choices.choice_posture.selected &amp;amp;&amp;amp; !choices.choice_iseposture.selected &amp;amp;&amp;amp; !choices.choice_fireamp.selected &amp;amp;&amp;amp; !choices.choice_nvm.selected &amp;amp;&amp;amp; !choices.choice_umbrella.selected));</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (choice_vpn_enabled()==<span class="literal">false</span>)</span></span><br><span class="line"><span class="undefined">        &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> tSelected;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> (tSelected &amp;amp;&amp;amp; my.choice.selected);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pkg-ref</span> <span class="attr">id</span>=<span class="string">"com.cisco.pkg.anyconnect.vpn"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bundle-version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bundle</span> <span class="attr">CFBundleShortVersionString</span>=<span class="string">"4.7.01076"</span> <span class="attr">CFBundleVersion</span>=<span class="string">"4.7.01076"</span> <span class="attr">id</span>=<span class="string">"com.cisco.Cisco-AnyConnect-Secure-Mobility-Client"</span> <span class="attr">path</span>=<span class="string">"Applications/Cisco/Cisco AnyConnect Secure Mobility Client.app"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bundle</span> <span class="attr">CFBundleVersion</span>=<span class="string">"4.7.01076"</span> <span class="attr">id</span>=<span class="string">"com.cisco.vpndownloader"</span> <span class="attr">path</span>=<span class="string">"opt/cisco/anyconnect/bin/vpndownloader.app"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bundle</span> <span class="attr">CFBundleShortVersionString</span>=<span class="string">"4.5.03023"</span> <span class="attr">CFBundleVersion</span>=<span class="string">"4.5.03023"</span> <span class="attr">id</span>=<span class="string">"com.cisco.Cisco-AnyConnect-Secure-Mobility-Client-Notification"</span> <span class="attr">path</span>=<span class="string">"opt/cisco/anyconnect/bin/Cisco AnyConnect Secure Mobility Client Notification.app"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bundle</span> <span class="attr">CFBundleShortVersionString</span>=<span class="string">"4.7.01076"</span> <span class="attr">CFBundleVersion</span>=<span class="string">"4.7.01076"</span> <span class="attr">id</span>=<span class="string">"com.cisco.uninstaller"</span> <span class="attr">path</span>=<span class="string">"Applications/Cisco/Uninstall AnyConnect.app"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">bundle-version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pkg-ref</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--     &lt;pkg-ref id="com.cisco.pkg.anyconnect.websecurity_v2"&gt;</span></span><br><span class="line"><span class="comment">        &lt;bundle-version/&gt;</span></span><br><span class="line"><span class="comment">    &lt;/pkg-ref&gt;</span></span><br><span class="line"><span class="comment">    &lt;pkg-ref id="com.cisco.pkg.anyconnect.fireamp"&gt;</span></span><br><span class="line"><span class="comment">        &lt;bundle-version/&gt;</span></span><br><span class="line"><span class="comment">    &lt;/pkg-ref&gt;</span></span><br><span class="line"><span class="comment">    &lt;pkg-ref id="com.cisco.pkg.anyconnect.dart"&gt;</span></span><br><span class="line"><span class="comment">        &lt;bundle-version&gt;</span></span><br><span class="line"><span class="comment">            &lt;bundle CFBundleShortVersionString="4.7.01076" id="com.cisco.pkg.anyconnect.dart" path="Applications/Cisco/Cisco AnyConnect DART.app"/&gt;</span></span><br><span class="line"><span class="comment">            &lt;bundle CFBundleShortVersionString="4.7.01076" CFBundleVersion="4.7.01076" id="com.cisco.dartuninstaller" path="Applications/Cisco/Uninstall AnyConnect DART.app"/&gt;</span></span><br><span class="line"><span class="comment">        &lt;/bundle-version&gt;</span></span><br><span class="line"><span class="comment">    &lt;/pkg-ref&gt;</span></span><br><span class="line"><span class="comment">    &lt;pkg-ref id="com.cisco.pkg.anyconnect.posture"&gt;</span></span><br><span class="line"><span class="comment">        &lt;bundle-version/&gt;</span></span><br><span class="line"><span class="comment">    &lt;/pkg-ref&gt;</span></span><br><span class="line"><span class="comment">    &lt;pkg-ref id="com.cisco.pkg.anyconnect.iseposture"&gt;</span></span><br><span class="line"><span class="comment">        &lt;bundle-version/&gt;</span></span><br><span class="line"><span class="comment">    &lt;/pkg-ref&gt;</span></span><br><span class="line"><span class="comment">    &lt;pkg-ref id="com.cisco.pkg.anyconnect.nvm_v2"&gt;</span></span><br><span class="line"><span class="comment">        &lt;bundle-version/&gt;</span></span><br><span class="line"><span class="comment">    &lt;/pkg-ref&gt;</span></span><br><span class="line"><span class="comment">    &lt;pkg-ref id="com.cisco.pkg.anyconnect.umbrella"&gt;</span></span><br><span class="line"><span class="comment">        &lt;bundle-version&gt;</span></span><br><span class="line"><span class="comment">            &lt;bundle CFBundleVersion="1.5.5" id="com.opendns.OpenDNS-Diagnostic" path="opt/cisco/anyconnect/bin/UmbrellaDiagnostic.app"/&gt;</span></span><br><span class="line"><span class="comment">        &lt;/bundle-version&gt;</span></span><br><span class="line"><span class="comment">    &lt;/pkg-ref&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">installer-gui-script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>简单看了下里面的判断逻辑，还需要吧<code>&lt;choice id=&quot;choice_vpn&quot; start_enabled=&quot;enable_module()&quot;</code>修改为<code>&lt;choice id=&quot;choice_vpn&quot; start_enabled=&quot;1&quot;</code>即可。</p>
<p>使用pkgutil重新打包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$pkgutil</span>  --flatten anyconnect Anyconnect-New.pkg</span><br></pre></td></tr></table></figure>
<p>重新挂载之前改为可读写的dmg，然后替换新的pkg文件。移除挂载后，再用macOS磁盘工具重新调整dmg的大小，调整后改为只读：</p>
<p><a href="https://support.apple.com/zh-cn/guide/disk-utility/dskuc033a48f/mac" target="_blank" rel="noopener">在 Mac 上使用“磁盘工具”调整磁盘映像大小</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$hdiutil</span> convert anyconnect-macos-4.7.01076-predeploy-k9-rw.dmg -format UDRO -o anyconnect-macos-4.7.01076-VPN.dmg</span><br></pre></td></tr></table></figure>
<p>参考资料：<br><a href="https://www.cisco.com/c/en/us/td/docs/security/vpn_client/anyconnect/anyconnect47/administration/guide/b_AnyConnect_Administrator_Guide_4-7/deploy-anyconnect.html" target="_blank" rel="noopener">Cisco AnyConnect Secure Mobility Client Administrator Guide, Release 4.7</a></p>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>原文作者: </span>
      <a href="http://nbma.info">Mansur</a>
    </p>
    <p class="copyright-item">
      <span>原文链接: </span>
      <a href="http://nbma.info/redeploy-anyconnect-for-macos/">http://nbma.info/redeploy-anyconnect-for-macos/</a>
    </p>
    <p class="copyright-item">
      <span>许可协议: </span>
      
      <a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/deed.zh" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>



      
      
  <div class="post-reward">
    <input type="checkbox" name="reward" id="reward" hidden>
    <label class="reward-button" for="reward">赞赏支持</label>
    <div class="qr-code">
      
      
        <label class="qr-code-image" for="reward">
          <img class="image" src="https://wx1.sinaimg.cn/large/68e0aeafly1frp3nwyrulj20jq0jqwh1.jpg" title="wechat">
        </label>
      
      
        <label class="qr-code-image" for="reward">
          <img class="image" src="https://wx1.sinaimg.cn/large/68e0aeafly1frp3nsphm6j20jq0jqacp.jpg" title="alipay">
        </label>
      
    </div>
  </div>

    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/network/">network</a>
            
              <a href="/tags/SSLVPN/">SSLVPN</a>
            
              <a href="/tags/cisco/">cisco</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/some-interesting-projects/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">一些有意思的项目</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/zabbix-wechat-alter/">
        <span class="next-text nav-default">zabbix添加企业微信告警</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:i@nbma.info" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
        
          <a href="https://twitter.com/iam__Peter" class="iconfont icon-twitter" title="twitter"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    

    
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>



<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2013 - 
    
    2020

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Mansur</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://nbma.info/redeploy-anyconnect-for-macos/';
        this.page.identifier = 'redeploy-anyconnect-for-macos/';
        this.page.title = '优化MacOS的Anyconnect安装包';
    };
    (function() {
    var d = document, s = d.createElement('script');

    s.src = '//nbma.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();  
  </script>

  

  



    
  



  
  





  
    <script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  

  
    <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.10.2"></script>

  </body>
</html>
